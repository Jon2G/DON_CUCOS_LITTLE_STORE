@page "/entrada"
@page "/salida"
@using Tabler.Docs.Components.Modals
@using Tabler.Docs.Interfaces
@using Tabler.Docs.Models
@using Tabler.Docs.ViewModels
@inject MovementsPageViewModel Model

@if (!AppData.Current.User.Permissions.Sales)
{
    <Forbbiden />
    return;
}


<Table Item="Movement" Items="Model.Movements" PageSize="10" OnItemSelected="OnselectedItem">
    <HeaderTemplate>
        <strong>Movimientos</strong>
    </HeaderTemplate>

    <ChildContent>
        <Column Item="Movement" Property="e => e.Date_m" Title="Fecha" Sortable Searchable Groupable />
        <Column Item="Movement" Property="e => e.User.Id" Title="Usuario" Sortable Searchable Groupable />
        <Column Item="Movement" Property="e => e.Concept" Title="Concepto" Sortable Searchable Groupable />
        <Column Item="Movement" Property="e => e.Type" Title="Tipo" Sortable Searchable Groupable />
        <Column Item="Movement" Property="e => e.Observations" Title="Observaciones" Sortable Searchable Groupable />
    </ChildContent>

</Table>
<Table Item="MovementPart" Items="Model.SelectedMovent.Parts" PageSize="10">
    <HeaderTemplate>
        <strong>Partes del movimiento</strong>
    </HeaderTemplate>

    <ChildContent>
        <Column Item="MovementPart" Property="e => e.Product.Code" Title="Código" Sortable Searchable Groupable />
        <Column Item="MovementPart" Property="e => e.Product.Name" Title="Producto" Sortable Searchable Groupable />
        <Column Item="MovementPart" Property="e => e.Quantity" Title="Cantidad" Sortable Searchable Groupable />
        <Column Item="MovementPart" Property="e => e.InitiallyStock" Title="Existencia inicial" Sortable Searchable Groupable />
        <Column Item="MovementPart" Property="e => e.NewStockB" Title="Existencia actual" Sortable Searchable Groupable />
        <Column Item="MovementPart" Property="e => e.Value" Title="Valor" Sortable Searchable Groupable />
    </ChildContent>

</Table>
<Button @onclick=@ShowModal BackgroundColor="TablerColor.Green">
    <Icon class="icon" Elements="@DemoIcons.Circle_plus" />
    Registrar
</Button>

@code
{
    [Inject] IModalService ModalService { get; set; }
    [Inject] TabBlazor.Services.TablerService TablerService { get; set; }
    [Inject] NavigationManager NavManager { get; set; }



    protected override void OnAfterRender(bool firstrender)
    {
        @if (Tabler.Docs.Data.AppData.Current.User.Id <= 0)
        {
            NavManager.NavigateTo("login");
        }}
    protected async Task ShowModal()
    {
        var component = new RenderComponent<MovementsView>().Set(x => x.Type, this.Model.Type);
        var result = await ModalService.ShowAsync($"Registrar {(Model.Type == 'S' ? "Salida" : "Entrada")}", component, new ModalOptions { Size = ModalSize.XLarge });

        if (!result.Cancelled)
        {
            await Model.Refresh();
            StateHasChanged();
        }

    }

    protected override async Task OnInitializedAsync()
    {
        if (NavManager.BaseUri.EndsWith("salida"))
        {
            await Model.Refresh('S');
        }
        else
        {
            await Model.Refresh('E');
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        Model.Refreshed += Refreshed;
    }

    private void Refreshed(object sender, EventArgs e)
    {
        //(sender as IRefresh).Refreshed -= Refreshed;
        StateHasChanged();
    }

    private async Task OnselectedItem(Movement movement)
    {
        Model.SelectedMovent = movement;
        await Model.SelectedMovent.Load();
    }
}